spring:
  application:
    name: liyaqa-backend

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 10MB

  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        format_sql: true
        jdbc:
          time_zone: UTC

  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.xml
    enabled: true

  jackson:
    default-property-inclusion: NON_NULL

server:
  port: ${SERVER_PORT:8080}
  error:
    include-message: always
    include-binding-errors: always
  compression:
    enabled: true
    min-response-size: 1024  # 1KB minimum for compression
    mime-types:
      - application/json
      - application/xml
      - text/html
      - text/xml
      - text/plain
      - text/css
      - text/javascript
      - application/javascript
      - image/svg+xml

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when_authorized
  # Prometheus metrics
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
      environment: ${ENVIRONMENT:dev}
  # Distributed tracing
  tracing:
    sampling:
      probability: ${TRACING_SAMPLE_RATE:0.1}  # Sample 10% of requests (100% in dev)
  zipkin:
    tracing:
      endpoint: ${ZIPKIN_ENDPOINT:http://localhost:9411/api/v2/spans}

# JWT Configuration
jwt:
  secret: ${JWT_SECRET:liyaqa-dev-secret-key-must-be-at-least-32-characters-long}
  access-token-expiration: 900000      # 15 minutes in milliseconds
  refresh-token-expiration: 604800000  # 7 days in milliseconds
  absolute-session-timeout: 86400000   # 24 hours in milliseconds (maximum session duration)

# Liyaqa Custom Configuration
liyaqa:
  # Domain configuration for subdomain-based multi-tenancy
  domain:
    base: ${LIYAQA_BASE_DOMAIN:liyaqa.local}  # Base domain for subdomain extraction
    dev-hosts: ${LIYAQA_DEV_HOSTS:localhost,127.0.0.1,liyaqa.local}  # Hostnames to skip subdomain detection
  email:
    enabled: ${EMAIL_ENABLED:false}  # Set to true to enable SMTP email
    from-address: ${EMAIL_FROM:noreply@liyaqa.com}
    from-name: Liyaqa
    base-url: ${EMAIL_BASE_URL:http://localhost:3000}
  sms:
    enabled: ${SMS_ENABLED:false}  # Set to true to enable SMS (Twilio)
    provider: ${SMS_PROVIDER:twilio}  # twilio or other providers
    twilio:
      account-sid: ${TWILIO_ACCOUNT_SID:}
      auth-token: ${TWILIO_AUTH_TOKEN:}
      from-number: ${TWILIO_FROM_NUMBER:}
  cors:
    allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:3001,http://localhost:3003,http://localhost:3004,http://localhost:3005,http://liyaqa.local:3000,http://liyaqa.local:3003}
    allowed-origin-patterns: ${CORS_ALLOWED_ORIGIN_PATTERNS:http://*.liyaqa.local:3000,http://*.liyaqa.local:3003,http://*.localhost:3000,http://*.localhost:3003}  # Wildcard patterns for subdomains
  impersonation:
    token-expiration-ms: ${IMPERSONATION_TOKEN_EXPIRATION_MS:1800000}  # 30 minutes
  team:
    invite-expiration-hours: ${TEAM_INVITE_EXPIRATION_HOURS:48}
    reset-expiration-hours: ${TEAM_RESET_EXPIRATION_HOURS:1}
    base-url: ${PLATFORM_BASE_URL:http://localhost:3001}
  api-keys:
    default-rate-limit: ${API_KEY_DEFAULT_RATE_LIMIT:60}
  security:
    hsts-enabled: ${HSTS_ENABLED:false}  # Enable only in production with HTTPS
    hsts-max-age-seconds: ${HSTS_MAX_AGE:31536000}  # 1 year
    content-security-policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'"
  payment:
    paytabs:
      profile-id: ${PAYTABS_PROFILE_ID:}
      server-key: ${PAYTABS_SERVER_KEY:}
      region: ${PAYTABS_REGION:SAU}
      currency: ${PAYTABS_CURRENCY:SAR}
      callback-url: ${PAYTABS_CALLBACK_URL:http://localhost:8080/api/payments/callback}
      return-url: ${PAYTABS_RETURN_URL:http://localhost:3000/payment/complete}
  storage:
    type: local
    max-file-size: ${MAX_FILE_SIZE:10485760}  # 10MB in bytes
    allowed-types:
      - image/jpeg
      - image/png
      - image/gif
      - image/webp
      - application/pdf
    local:
      upload-dir: ${UPLOAD_DIR:./uploads}
  zatca:
    enabled: ${ZATCA_ENABLED:false}  # Enable Zatca e-invoicing compliance
    seller-name: ${ZATCA_SELLER_NAME:}  # Business name for QR code
    vat-registration-number: ${ZATCA_VAT_NUMBER:}  # VAT registration number
  billing:
    default-vat-rate: ${DEFAULT_VAT_RATE:15.00}  # Saudi Arabia VAT rate (15%)
  firebase:
    enabled: ${FIREBASE_ENABLED:false}  # Set to true to enable push notifications
    service-account-path: ${FIREBASE_SERVICE_ACCOUNT_PATH:}  # Path to service account JSON file
    service-account-json: ${FIREBASE_SERVICE_ACCOUNT_JSON:}  # JSON string for containerized deployments

# OpenAPI/Swagger Configuration
springdoc:
  api-docs:
    path: /api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    operationsSorter: method
    tagsSorter: alpha
  packages-to-scan: com.liyaqa
  paths-to-match: /api/**

logging:
  level:
    root: INFO
    com.liyaqa: DEBUG
    org.springframework.web: INFO
    org.hibernate.SQL: DEBUG

---
# Development Profile
spring:
  config:
    activate:
      on-profile: dev

  datasource:
    url: jdbc:h2:mem:liyaqa;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;MODE=PostgreSQL
    driver-class-name: org.h2.Driver
    username: sa
    password:

  h2:
    console:
      enabled: true
      path: /h2-console

  liquibase:
    enabled: false

  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true

logging:
  level:
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

---
# Production Profile
spring:
  config:
    activate:
      on-profile: prod

  datasource:
    url: ${DATABASE_URL}
    username: ${DATABASE_USERNAME}
    password: ${DATABASE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      # Connection Pool Sizing
      # Formula: connections = ((core_count * 2) + effective_spindle_count)
      # For typical server: (4 cores * 2) + 1 = 9, rounded to 10-20
      maximum-pool-size: ${DB_POOL_SIZE:20}  # Max connections (reduced from 30 to avoid saturation)
      minimum-idle: ${DB_POOL_MIN_IDLE:5}    # Min idle connections

      # Connection Timeouts
      connection-timeout: 30000              # 30s - Max wait for connection from pool
      idle-timeout: 600000                   # 10min - Max idle time before connection close
      max-lifetime: 1800000                  # 30min - Max connection lifetime (prevents stale connections)

      # Validation
      validation-timeout: 5000               # 5s - Max time for connection validation

      # Keepalive (prevents connection drops)
      keepalive-time: 300000                 # 5min - Keepalive interval

      # Leak Detection (dev/staging only)
      leak-detection-threshold: ${DB_LEAK_DETECTION:0}  # 0=disabled, 30000=30s in dev

      # Pool Name
      pool-name: LiyaqaHikariPool

      # Auto-commit (false for explicit transaction control)
      auto-commit: false

      # Connection Properties
      data-source-properties:
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
        useLocalSessionState: true
        rewriteBatchedStatements: true
        cacheResultSetMetadata: true
        cacheServerConfiguration: true
        elideSetAutoCommits: true
        maintainTimeStats: false

  jpa:
    hibernate:
      ddl-auto: update  # Changed from validate for Docker setup - Hibernate creates tables
    show-sql: false

  # SMTP Email Configuration (for production)
  mail:
    host: ${SMTP_HOST:smtp.gmail.com}
    port: ${SMTP_PORT:587}
    username: ${SMTP_USERNAME:}
    password: ${SMTP_PASSWORD:}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
          connectiontimeout: 5000
          timeout: 5000
          writetimeout: 5000

liyaqa:
  domain:
    base: ${LIYAQA_BASE_DOMAIN:liyaqa.com}
    dev-hosts: ${LIYAQA_DEV_HOSTS:}  # Empty in production
  email:
    enabled: ${EMAIL_ENABLED:true}
    from-address: ${EMAIL_FROM:noreply@liyaqa.com}
    from-name: Liyaqa
    base-url: ${EMAIL_BASE_URL:https://liyaqa.com}
  sms:
    enabled: ${SMS_ENABLED:true}
    provider: ${SMS_PROVIDER:twilio}
    twilio:
      account-sid: ${TWILIO_ACCOUNT_SID}
      auth-token: ${TWILIO_AUTH_TOKEN}
      from-number: ${TWILIO_FROM_NUMBER}
  cors:
    allowed-origins: ${CORS_ALLOWED_ORIGINS}  # Required in production: comma-separated list of allowed origins
    allowed-origin-patterns: ${CORS_ALLOWED_ORIGIN_PATTERNS:https://*.liyaqa.com}  # Wildcard for subdomains
  security:
    hsts-enabled: true  # Enable HSTS in production (requires HTTPS)
    hsts-max-age-seconds: 31536000  # 1 year
    content-security-policy: "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'"
  payment:
    paytabs:
      profile-id: ${PAYTABS_PROFILE_ID}
      server-key: ${PAYTABS_SERVER_KEY}
      region: ${PAYTABS_REGION:SAU}
      currency: ${PAYTABS_CURRENCY:SAR}
      callback-url: ${PAYTABS_CALLBACK_URL}
      return-url: ${PAYTABS_RETURN_URL}
  zatca:
    enabled: ${ZATCA_ENABLED:true}  # Zatca required in production
    seller-name: ${ZATCA_SELLER_NAME}
    vat-registration-number: ${ZATCA_VAT_NUMBER}
  billing:
    default-vat-rate: ${DEFAULT_VAT_RATE:15.00}  # Saudi Arabia VAT rate (15%)
  firebase:
    enabled: ${FIREBASE_ENABLED:true}  # Push notifications enabled in production
    service-account-path: ${FIREBASE_SERVICE_ACCOUNT_PATH:}
    service-account-json: ${FIREBASE_SERVICE_ACCOUNT_JSON}  # Required in production

app:
  frontend:
    base-url: ${FRONTEND_BASE_URL:https://app.liyaqa.com}  # Frontend base URL for email links

logging:
  level:
    root: WARN
    com.liyaqa: INFO
    org.hibernate.SQL: WARN
